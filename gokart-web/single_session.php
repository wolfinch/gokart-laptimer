<html>
<head>
<title>Gokart Session</title>
<style type="text/css">
body {
	background-image: url("f1-bg-logo-front.jpg");
	background-repeat: no-repeat;
	background-size: cover;
}
</style>
</head>
<style type="text/css">
.tg {
	border-collapse: collapse;
	border-spacing: 0;
	border-color: #aabcfe;
}

.tg td {
	font-family: Arial, sans-serif;
	font-size: 14px;
	padding: 10px 5px;
	border-style: solid;
	border-width: 1px;
	overflow: hidden;
	word-break: normal;
	border-color: #aabcfe;
	color: #669;
	background-color: #e8edff;
}

.tg th {
	font-family: Arial, sans-serif;
	font-size: 14px;
	font-weight: normal;
	padding: 10px 5px;
	border-style: solid;
	border-width: 1px;
	overflow: hidden;
	word-break: normal;
	border-color: #aabcfe;
	color: #039;
	background-color: #b9c9fe;
}

.tg .tg-vn4c {
	background-color: #D2E4FC
}

.tg .tg-2fkl {
	font-weight: bold;
	font-size: 36px;
	text-align: center
}

.tg .tg-if22 {
	background-color: #D2E4FC;
	font-weight: bold;
	font-size: 22px
}

.tg .tg-5rcs {
	font-weight: bold;
	font-size: 20px
}

.tg .tg-sh0f {
	font-weight: bold;
	font-size: 20px;
	text-align: right
}

.tg .tg-m08s {
	background-color: #D2E4FC;
	font-weight: bold;
	font-size: 20px
}

.button {
	border: 1px solid #0a3c59;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#65a9d7),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #65a9d7, #3e779d);
	background: -moz-linear-gradient(top, #65a9d7, #3e779d);
	background: -ms-linear-gradient(top, #65a9d7, #3e779d);
	background: -o-linear-gradient(top, #65a9d7, #3e779d);
	background-image: -ms-linear-gradient(top, #65a9d7 0%, #3e779d 100%);
	padding: 10.5px 21px;
	-webkit-border-radius: 6px;
	-moz-border-radius: 6px;
	border-radius: 6px;
	-webkit-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	-moz-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	text-shadow: #7ea4bd 0 1px 0;
	color: #06426c;
	font-size: 14px;
	font-family: helvetica, serif;
	text-decoration: none;
	vertical-align: middle;
}

.button:hover {
	border: 1px solid #0a3c59;
	text-shadow: #1e4158 0 1px 0;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#65a9d7),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #65a9d7, #3e779d);
	background: -moz-linear-gradient(top, #65a9d7, #3e779d);
	background: -ms-linear-gradient(top, #65a9d7, #3e779d);
	background: -o-linear-gradient(top, #65a9d7, #3e779d);
	background-image: -ms-linear-gradient(top, #65a9d7 0%, #3e779d 100%);
	color: #fff;
}

.button:active {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3e779d),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #3e779d, #65a9d7);
	background: -moz-linear-gradient(top, #3e779d, #65a9d7);
	background: -ms-linear-gradient(top, #3e779d, #65a9d7);
	background: -o-linear-gradient(top, #3e779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #fff;
}

.button:disabled {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3a779d),
		to(#3a779d) );
	background: -webkit-linear-gradient(top, #3a779d, #65a9d7);
	background: -moz-linear-gradient(top, #3a779d, #65a9d7);
	background: -ms-linear-gradient(top, #3a779d, #65a9d7);
	background: -o-linear-gradient(top, #3a779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #fff;
}

.button2 {
	border: 1px solid #0a3c59;
	background: #c7473b;
	background: -webkit-gradient(linear, left top, left bottom, from(#c7473b),
		to(#f27413) );
	background: -webkit-linear-gradient(top, #c7473b, #f27413);
	background: -moz-linear-gradient(top, #c7473b, #f27413);
	background: -ms-linear-gradient(top, #c7473b, #f27413);
	background: -o-linear-gradient(top, #c7473b, #f27413);
	background-image: -ms-linear-gradient(top, #c7473b 0%, #f27413 100%);
	padding: 10.5px 21px;
	-webkit-border-radius: 6px;
	-moz-border-radius: 6px;
	border-radius: 6px;
	-webkit-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	-moz-box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	box-shadow: rgba(255, 255, 255, 0.4) 0 1px 0, inset
		rgba(255, 255, 255, 0.4) 0 1px 0;
	text-shadow: #7ea4bd 0 1px 0;
	color: #fff;
	font-size: 14px;
	font-family: helvetica, serif;
	text-decoration: none;
	vertical-align: middle;
}

.button2:hover {
	border: 1px solid #0a3c59;
	text-shadow: #1e4158 0 1px 0;
	background: #3e779d;
	background: -webkit-gradient(linear, left top, left bottom, from(#c7473b),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #c7473b, #f27413);
	background: -moz-linear-gradient(top, #c7473b, #f27413);
	background: -ms-linear-gradient(top, #c7473b, #f27413);
	background: -o-linear-gradient(top, #c7473b, #f27413);
	background-image: -ms-linear-gradient(top, #c7473b 0%, #f27413 100%);
	color: #06426c;
}

.button2:active {
	text-shadow: #1e4158 0 1px 0;
	border: 1px solid #0a3c59;
	background: #65a9d7;
	background: -webkit-gradient(linear, left top, left bottom, from(#3e779d),
		to(#3e779d) );
	background: -webkit-linear-gradient(top, #3e779d, #65a9d7);
	background: -moz-linear-gradient(top, #3e779d, #65a9d7);
	background: -ms-linear-gradient(top, #3e779d, #65a9d7);
	background: -o-linear-gradient(top, #3e779d, #65a9d7);
	background-image: -ms-linear-gradient(top, #3e779d 0%, #65a9d7 100%);
	color: #ffff;
}

input[type="text"]:disabled {
	background: #ffffff;
}
</style>

<?php
require_once 'class_defines.php';

error_reporting(E_ERROR | E_PARSE | E_NOTICE);

global $kart_session_data ;
global $GlobalData;

$GlobalData 		= unserialize(include($_SERVER['DOCUMENT_ROOT']."/data_config.php"));
$kart_session_data  = unserialize(include($_SERVER['DOCUMENT_ROOT']."/data_session.php"));

//var_dump($kart_session_data);

function sendHttpRequest_internal($cmd) {
	global $GlobalData;

	if (empty($GlobalData->serverIp)) {
		if(empty($GlobalData->serverName)) {
			echo "invalid hostname and ip:".$GlobalData->serverName."<br>";
			return FALSE;
		}
		$host_ip = gethostbyname ($GlobalData->serverName);
		if (!empty($host_ip)) {
			echo "host IP resolved for hostname and ip:".$GlobalData->serverName.$host_ip."<br>";
			$GlobalData->serverIp= $host_ip;
		} else {
			echo "gethostbyname failure on host:".$GlobalData->serverName."<br>";
			return FALSE;
		}
	} else {
		$host_ip = $GlobalData->serverIp;
	}

	$port = $GlobalData->serverPort;
	if(empty($port)) {
		echo "invalid port for host".$GlobalData->serverPort.$GlobalData->serverPort."<br>";
		return FALSE;
	}

	if (!($fp = fsockopen($host_ip, $port))) {
		echo "Could not connect to server:".$host_ip."<br>";
		return FALSE;
	}

	//  construct request
	//if ($cmd != "START" && $cmd != "STOP" && $cmd != "STATUS") {
	//echo "Invalid request cmd:".$cmd."<br>";
	//return FALSE;
	//}

	$request = "GET ".$cmd." HTTP/1.1\r\n";
	//$request = "GET HTTP/1.1\r\n";
	//	echo "request:".$request."<br>";

	//  write request to socket
	fwrite($fp, $request);

	//  read the status line
	$line  = fgets($fp, 2048);
	if(FALSE !== strpos($line, "200 OK")) {
		//		echo "status OK Recvd: ".$line."<br>";
		fclose ($fp);
		return TRUE;
	}
	//$status = explode(" ", $line);
	$line = "";
	while (!feof($fp)) {
		$line .= fgets($fp, 2048);
	}
	echo "command failed! Recvd:".$line."<br>";
	return FALSE;
}

function sendHttpRequest($cmd) {
	return sendHttprequest_internal($cmd);
	//return True;
}

// Cleanup session data
function cleanupSession ($devId) {
	global $kart_session_data;
	
	/* $devId = -1 => all */
	if ($devId == -1) {
		// Clear the session data store
		for ($i=1; $i <= MAX_KART_NUM; $i++) {
			$kart_session_data[$i] = new sessionData($i);		
		}
	}
	
	// Get the configured names

	//if the dir doesn't exist, return
	if(False === is_dir(UPLOAD_DIR)) {
		return;
	}

	$dir = new DirectoryIterator(UPLOAD_DIR);
	foreach ($dir as $fileinfo) {
		if ($fileinfo->isDot()) {
			continue;
		}
		$file = $fileinfo->getPathname();
		
		if($devId != -1 && (false === strpos($file, 'KART'.$devId))) {
			continue;
		}
		//echo $file."<br>";		
		unlink ($file);
	}
}

//if (FALSE == sendHttpRequest("STATUS:") ) {
//	echo "Failed to send STATUS request <br>";
//}

function handleSwitch($devId, $textBoxName) {
	global $GlobalData;
	global $kart_session_data;
	$ret = TRUE;

	if($kart_session_data[$devId]->isStarted() == True) {
		// Send stop command
		if (FALSE == sendHttpRequest("STOP:KART".$devId.":") ) {
			echo "Failed to send STOP request for ".$devName."<br>".
					"<br> Please check the connection with Server <br>";
			$ret = FALSE;
		}
		($kart_session_data[$devId]->start(False));
	} else {
		$kart_session_data[$devId] = new sessionData($devId, $_POST[$textBoxName]);
		//cleanup the previous session for the device
		//cleanupSession ($devId);
		// Send Start command
		if (FALSE == sendHttpRequest("START:KART".$devId.":") ) {
			echo "Failed to send START request for kart".$devId.
					"<br> Please check the connection with Server <br>";
			$ret = FALSE;
			//return FALSE;
		} else {
			($kart_session_data[$devId]->start(True));
		}
	}
	//var_dump($GlobalData);
	// store the config
	file_put_contents('data_config.php', '<?php return ' . var_export(serialize($GlobalData), true) . '; ?>', LOCK_EX);
	file_put_contents('data_session.php', '<?php return ' . var_export(serialize($kart_session_data), true) . '; ?>', LOCK_EX);		
	return $ret;
}

//$Started = False;
for ($i = 1; $i <= MAX_KART_NUM; $i++) {
	if ( isset($_POST["Dev".$i."Btn"])){
		handleSwitch ($i, 'kart'.$i.'Text');
	}
}

if (isset($_POST["newBtn"])) {
	//echo ("new session: <br/>\n\n");
	// cleanup the session data
	cleanupSession (-1); /* To clean up all session ids */
	// store the config
	file_put_contents('data_session.php', '<?php return ' . var_export(serialize($kart_session_data), true) . '; ?>', LOCK_EX);			
}

/* This will clear everything */
if (isset($_POST["clearAllBtn"])) {
	// cleanup the session data
	cleanupSession (-1); /* To clean up all session ids */
	$GlobalData = new globalData($GlobalData->serverName,
						$GlobalData->serverIp,
						$GlobalData->serverPort);	
	// store the config
	file_put_contents('data_session.php', '<?php return ' . var_export(serialize($kart_session_data), true) . '; ?>', LOCK_EX);
	file_put_contents('data_config.php', '<?php return ' . var_export(serialize($GlobalData), true) . '; ?>', LOCK_EX);		
}

if (isset($_POST["editBtn"])) {
	//cannot change server details if session started
	if($GlobalData->isStarted() === FALSE) {
		if ($GlobalData->inEdit != TRUE) {
			$GlobalData->inEdit = TRUE;
		} else {
			/* This is submit */
			$GlobalData->updateServer((("Server" != $_POST['serverName'])?$_POST['serverName']:""),
						(("Ip" != $_POST['serverIp'])?$_POST['serverIp']:""),
						(("Port" != $_POST['serverPort'])?$_POST['serverPort']:""));
			$GlobalData->inEdit = FALSE;
			//var_dump($GlobalData);			
		}
		file_put_contents('data_config.php', '<?php return ' . var_export(serialize($GlobalData), true) . '; ?>', LOCK_EX);	
	}
}
?>

<form action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">
	<table class="tg">
		<tr>
			<th class="tg-2fkl" colspan="5">Session Entry</th>
		</tr>
		<tr>
			<td class="tg-if22">Kart No</td>
			<td class="tg-if22">Driver Name</td>
			<td class="tg-if22"></td>
			<td class="tg-if22" align="center">Lap <br> Count</td>			
			<td class="tg-if22" align="center">Battery <br> Level</td>			
		</tr>
		<?php
		for ($i = 1; $i <= MAX_KART_NUM; $i++) {
			echo "<tr>";
			echo "<td class=\"tg-5rcs\" align=\"center\">".$i."</td>";
			echo "<td class=\"tg-5rcs\"><input type=\"text\" size=\"20\"";
			echo "Value=\"".$kart_session_data[$i]->drvName."\" name=\"kart".$i."Text\"";
			echo "maxlength=\"15\" ";
			if($kart_session_data[$i]->isStarted() == True){echo "style=\"background-color: #D2E4FC;\"disabled />";} else {echo "/>";};
			echo "</td>";
			echo "<td class=\"tg-sh0f\" align=\"center\"><input type=\"submit\"";
			if($kart_session_data[$i]->isStarted() == False){echo "class=\"button\" ";} else {echo "class=\"button2\"";}
			echo "name=\"Dev".$i."Btn\"";
			if($kart_session_data[$i]->isStarted() == False){echo "Value=\"Start\" />";} else {echo "Value=\"Stop\" />";}
			echo "</td>";
			echo "<td class=\"tg-sh0f\" align=\"center\"><div id=\"lap_count".$i."\" align=\"center\"></div></td>";	
			echo "<td class=\"tg-sh0f\" align=\"center\"><div id=\"battery_level".$i."\" align=\"center\"></div></td>";						
			echo "</tr>";
		}
		echo "<tr><td colspan=\"2\" align=\"left\" style=\"border-right-width: 0px;\">";
		echo "<input type=\"submit\" onclick=\"return confirmPopUp();\" Value=\"Clear All Data\" class=\"button\" name=\"clearAllBtn\" />";
		echo "</td><td colspan=\"3\" align=\"right\" style=\"border-left-width: 0px;\">";
		echo "<input type=\"submit\" Value=\"Clear Session\" class=\"button\" name=\"newBtn\" />";
		echo "</td></tr>"		
		?>
	</table>
	<br>
	<table class="tg">
		<tr>
			<th class="tg-if22" colspan="3">Server Details</th>
		</tr>
		<tr>
			<td class="tg-if22">Server Name</td>
			<td class="tg-if22">Server IP</td>
			<td class="tg-if22">Port</td>
		</tr>
		<tr>
		<?php 
		global $GlobalData;
			echo "<td class=\"tg-5rcs\"><input type=\"text\" size=20 Value=";				
				if (empty($GlobalData->serverName)) 
				{
					echo "\"Server\"";
				} else {
					echo "\"".$GlobalData->serverName."\"";
				}
			echo "name=\"serverName\" maxlength=\"15\" ";
				if($GlobalData->inEdit != True){
					echo "style=\"background-color: #D2E4FC;\" disabled />";
				} else {
					echo "/>";
				} 			
			echo "</td>";
			echo "<td class=\"tg-5rcs\"><input type=\"text\" size=20 Value=";
				if (empty($GlobalData->serverIp)) {
					echo "\"Ip\"";
				} else {
					echo "\"".$GlobalData->serverIp."\"";
				}
			echo "name=\"serverIp\" maxlength=\"15\" ";
		 		if($GlobalData->inEdit != True){
		 			echo "style=\"background-color: #D2E4FC;\" disabled />";
		 		} else {
		 			echo "/>";
		 		}			
			echo "</td>";
			echo "<td class=\"tg-5rcs\"><input type=\"text\" size=20 Value=";
				if (empty($GlobalData->serverPort)) {
					echo "\"Port\"";
				} else {
					echo "\"".$GlobalData->serverPort."\"";
				}
			echo "name=\"serverPort\" maxlength=\"15\" ";
				if($GlobalData->inEdit != True){
					echo "style=\"background-color: #D2E4FC;\" disabled />";
				} else {
					echo "/>";
				}
			echo "</td>";
		echo "</tr><tr>";
		echo "<td colspan=\"3\" align=\"right\">";
		echo "<input type=\"submit\" Value=";
			if ($GlobalData->inEdit == TRUE) {
				echo "\"Submit\" class=\"button2\"";
			} else {
				echo "\"Edit\" class=\"button\"";
			}
		echo "name=\"editBtn\" " ;
			if ($GlobalData->isStarted() == TRUE) {
				echo "disabled />";
			}else {
				echo "/>";
			}			
		echo "</td></tr>";
		//var_dump($GlobalData);
		?>
	</table>
	<br>
</form>

<body>
	<div id="status_query" align="center"></div>
</body>

<footer align='Center'> 
© Copyright 2015 Joshith (joe.cet@gmail.com), all rights reserved 
</footer>

<script type="text/javascript" src="jquery-1.11.2.min.js"> </script>
<script>
function confirmPopUp() {
    return confirm("This will clear all data including historical data!\nClick OK to confirm");
}
var auto_refresh = setInterval( function () {
	$.ajax( {
		url : 'status_query.php',
		type : 'GET',
		dataType : 'html',			
		success : function( resp ) {
			<?php 
			for ($i = 1; $i<= MAX_KART_NUM; $i++) {
				echo "$('#lap_count".$i."').html($('#lap_count".$i."' , resp).html())\n";
				echo "$('#battery_level".$i."').html($('#battery_level".$i."' , resp).html())\n";
			}
			?>
		}
	})
	} , 5000)
$(document).ready(function () {
	$.ajax( {
		url : 'status_query.php',
		type : 'GET',
		dataType : 'html',			
		success : function( resp ) {
			<?php 
			for ($i = 1; $i<= MAX_KART_NUM; $i++) {
				echo "$('#lap_count".$i."').html($('#lap_count".$i."' , resp).html())\n";
				echo "$('#battery_level".$i."').html($('#battery_level".$i."' , resp).html())\n";
			}
			?>
			}
	})
	})

</script>
</html>